% ensures all validation and inference data are completely independent from
% training data (i.e. not used in any of the same forward or backward
% registrations). Should be run after dataset_split.csv is generated but
% before training begins.

clear all; close all

%% load existing dataset_split.csv (autogenerated code)
filename = 'highres3dnet_hippocampus_parcellation/dataset_split.csv';
delimiter = ',';
formatSpec = '%s%s%[^\n\r]';
fileID = fopen(filename,'r');
dataArray = textscan(fileID, formatSpec, 'Delimiter', delimiter, 'TextType', 'string', 'EmptyValue', NaN,  'ReturnOnError', false);
fclose(fileID);
datasetsplit = [dataArray{1:end-1}];
clearvars filename delimiter formatSpec fileID dataArray ans;

%% set new splitting based on subjectID rather than filename
% target proportions: 0.75 training; 0.2 validation, 0.05 inference
% subjects breakdown: 24 agile12; 22 UPenn; 19 HCP (65 total)
% agile12: 4 validation; 1 inference
% UPenn: 4 validation; 1 inference
% HCP: 4 validation; 1 inference
% actual proportions: 0.7538 training, 0.2 inference, 0.0462 inference
datasetsplit(:,2) = 'training';

% for validation (chosen blindly):
valAgile12 = {'sub025_hemiR';'sub075_hemiL';'sub071_hemiL'};
valUPenn = {'NDRI64448R';'NDRI64443R';'INDD119294L'};
valHCP = {'HCP100408_hemiL';'HCP111312_hemiR'};
validation = {valAgile12{:} valUPenn{:} valHCP{:}};

v=cellfun(@(x) contains(x,validation),datasetsplit,'UniformOutput',0);
v=find(cell2mat(v(:,1)));
datasetsplit(v,2) = 'validation';

% for inference (chosen blindly but not matching validation):
infAgile12 = {'sub071_hemiL'};
infUPenn = {'NDRI64823L'};
infHCP = {'HCP130013_hemiL'};
inference = {infAgile12{:} infUPenn{:} infHCP{:}};

i=cellfun(@(x) contains(x,inference),datasetsplit,'UniformOutput',0);
i=find(cell2mat(i(:,1)));
datasetsplit(i,2) = 'inference';

%% double check proportions:
ninf = length(find(contains(datasetsplit,'inference')));
nval = length(find(contains(datasetsplit,'validation')));
ntrain = length(find(contains(datasetsplit,'training')));
l = size(datasetsplit,1);

fprintf('actual proportions: training %f; validation %f; inference %f\n',ntrain/l,nval/l,ninf/l);

%% save
t = cellstr(datasetsplit);
T = cell2table(t(2:end,:),'VariableNames',t(1,:));
writetable(T,'highres3dnet_hippocampus_parcellation/dataset_split.csv')
